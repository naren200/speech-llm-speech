# docker run --gpus all -it csaba1padma/padma-ros-repo:latest
# docker build --ssh default -t padma-ros .
# docker run --gpus all -it padma-ros
# run for development:
# xhost +local:docker; docker run --init --privileged -v /dev/bus/usb:/dev/bus/usb -e DISPLAY=$DISPLAY  -v /tmp/.X11-unix:/tmp/.X11-unix --gpus all -it --rm csaba1padma/padma-ros-repo:latest

# Use an official NVIDIA runtime as a parent image
# https://hub.docker.com/r/nvidia/cuda/tags
# FROM nvidia/cuda:12.3.1-base-ubuntu22.04
# FROM nvidia/cuda:12.3.1-runtime-ubuntu22.04
FROM nvidia/cuda:12.3.1-devel-ubuntu22.04
# FROM ubuntu:22.04

# use bash as assumed for install steps
SHELL ["/bin/bash", "-c"]

# # Set DEBIAN_FRONTEND to noninteractive
ENV TZ='America/New_York'
ENV DEBIAN_FRONTEND=noninteractive
ENV ROS_DISTRO=iron
# assume GPU available for inference
# ARG USE_GPU=false
# NVIDIA Configuration
ENV NVIDIA_VISIBLE_DEVICES all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility,graphics
ENV PATH /usr/local/nvidia/bin:/usr/local/cuda/bin:${PATH}
ENV LD_LIBRARY_PATH /usr/local/nvidia/lib:/usr/local/nvidia/lib64:/usr/local/cuda/lib64:${LD_LIBRARY_PATH}

# Install basic dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    software-properties-common \
    git \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

RUN curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \
  && curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
    sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
    tee /etc/apt/sources.list.d/nvidia-container-toolkit.list

# Install NVIDIA CUDA Toolkit and utilities
RUN apt-get update && apt-get install -y \
    nvidia-cuda-toolkit \
    nvidia-utils-535 \
    cuda-command-line-tools-12-3 \
    && rm -rf /var/lib/apt/lists/*

# Set CUDA environment variables
ENV CUDA_HOME=/usr/local/cuda
ENV PATH=${CUDA_HOME}/bin:${PATH}
ENV LD_LIBRARY_PATH=${CUDA_HOME}/lib64:${LD_LIBRARY_PATH}

RUN apt-get update && \
    apt-get install -y nvidia-container-toolkit && \
    nvidia-ctk runtime configure --runtime=docker


# # Install NVIDIA development tools
# RUN apt-get update && apt-get install -y \
#     nvidia-utils-535 \
#     && rm -rf /var/lib/apt/lists/*

# Install Ollama
RUN curl -fsSL https://ollama.com/install.sh | sh

# copy packages from S3 buckets
# COPY Vimba64_v6.0_Linux.tgz /root/

RUN apt-get update -y

# install ROS2
RUN locale  # check for UTF-8
RUN apt install -y locales
RUN locale-gen en_US en_US.UTF-8
RUN update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8
ENV LANG=en_US.UTF-8
RUN locale  # verify settings

RUN apt install -y software-properties-common
RUN add-apt-repository universe

RUN apt update -y && apt install curl -y
RUN curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg

RUN echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | tee /etc/apt/sources.list.d/ros2.list > /dev/null

RUN apt update -y && apt install -y ros-dev-tools

RUN apt update -y
RUN apt upgrade -y
RUN apt install -y dialog
RUN apt install -y ros-iron-desktop

RUN echo "source /opt/ros/iron/setup.bash" >> ~/.bashrc
# ENV ROS_DOMAIN_ID 0
RUN echo "export ROS_DOMAIN_ID=0" >> ~/.bashrc

RUN apt install -y xterm

# this step is from: https://github.com/webfactory/ssh-agent
# COPY root-config /root/
# RUN sed 's|/home/runner|/root|g' -i.bak /root/.ssh/config

RUN apt install -y git
RUN mkdir -p /root/ros2_ws/src/speech-llm-speech

# copy padma-ros repo (local code)
COPY . /root/ros2_ws/src/speech-llm-speech/

WORKDIR /root/ros2_ws/src/whisper_asr/src/

# mount type is necessary here!
# RUN git clone https://github.com/ros-ai/ros2_whisper_cpp.git
# WORKDIR /root/ros2_ws/src/whisper_cpp/
# RUN make install

# Clean up SSH keys and configuration
RUN rm -rf /root/.ssh

WORKDIR /root/ros2_ws

RUN rosdep init
RUN rosdep update
# RUN rosdep install -i --from-path src --rosdistro iron -y

RUN mkdir /var/log/speech-llm-speech

RUN apt-get update -y
RUN apt-get install -y python3-pip
RUN pip3 install --upgrade pip

WORKDIR /root/ros2_ws/src/speech-llm-speech/

# Install any needed packages specified in requirements.txt
# make sure --ignore-installed doesnt break things; without it there was an error uninstalling blinker
RUN pip install --no-cache-dir --ignore-installed -r requirements.txt

RUN apt-get update -y

RUN apt install -y ros-iron-ament-cmake-clang-format

# some other useful things
RUN apt-get update -y && apt install -y gedit

# Kaylee request, to suppress warnings
RUN pip3 install setuptools==58.2.0

RUN apt-get install portaudio19-dev -y
RUN pip3 install pyaudio

WORKDIR /root/ros2_ws/

# Build packages
# * Reference: https://docs.ros.org/en/iron/Tutorials/Beginner-Client-Libraries/Colcon-Tutorial.html
# * Reference: https://docs.ros.org/en/iron/Tutorials/Colcon-Tutorial.html

RUN apt-get update && \
    apt-get install -y software-properties-common && \
    add-apt-repository universe && \
    apt-get update && \
    apt-get install -y \
    libcurl4-openssl-dev \
    nlohmann-json3-dev \
    && rm -rf /var/lib/apt/lists/*

# Install required ROS2 development packages
RUN apt-get update && apt-get install -y \
python3-colcon-common-extensions \
ros-iron-ament-cmake \
ros-iron-ament-cmake-auto \
&& rm -rf /var/lib/apt/lists/*

RUN /bin/bash -c 'source /opt/ros/iron/setup.bash && colcon build --cmake-args -DCMAKE_BUILD_TYPE=Release'

RUN apt install python3-rosdep

# Source ROS2 axnd build in a single RUN command
RUN /bin/bash -c 'source /opt/ros/iron/setup.bash && \
    colcon build --cmake-args -DCMAKE_BUILD_TYPE=Release'


# Set the default command to an interactive login shell
CMD ["/bin/bash", "-l"]
